from ROOT import TH3D, TH1D, TFile
from array import array
import copy
from math import *

#binning dictionary: first key = channel name, second key = "x","y", or "z"
BINS_FINE = {
't3_muplus_SR':{'x':array('d',[-1.000000,-0.980000,-0.960000,-0.940000,-0.920000,-0.900000,-0.880000,-0.860000,-0.840000,-0.820000,-0.800000,-0.780000,-0.760000,-0.740000,-0.720000,-0.700000,-0.680000,-0.660000,-0.640000,-0.620000,-0.600000,-0.580000,-0.560000,-0.540000,-0.520000,-0.500000,-0.480000,-0.460000,-0.440000,-0.420000,-0.400000,-0.380000,-0.360000,-0.340000,-0.320000,-0.300000,-0.280000,-0.260000,-0.240000,-0.220000,-0.200000,-0.180000,-0.160000,-0.140000,-0.120000,-0.100000,-0.080000,-0.060000,-0.040000,-0.020000,0.000000,0.020000,0.040000,0.060000,0.080000,0.100000,0.120000,0.140000,0.160000,0.180000,0.200000,0.220000,0.240000,0.260000,0.280000,0.300000,0.320000,0.340000,0.360000,0.380000,0.400000,0.420000,0.440000,0.460000,0.480000,0.500000,0.520000,0.540000,0.560000,0.580000,0.600000,0.620000,0.640000,0.660000,0.680000,0.700000,0.720000,0.740000,0.760000,0.780000,0.800000,0.820000,0.840000,0.860000,0.880000,0.900000,0.920000,0.940000,0.960000,0.980000,1.000000]),
'y':array('d',[0.000000,0.005227,0.010454,0.015680,0.020907,0.026134,0.030299,0.034464,0.038630,0.042795,0.046960,0.050096,0.053232,0.056367,0.059503,0.062639,0.065748,0.068856,0.071965,0.075073,0.078182,0.081797,0.085412,0.089026,0.092641,0.096256,0.099924,0.103593,0.107261,0.110930,0.114598,0.118644,0.122690,0.126737,0.130783,0.134829,0.138834,0.142839,0.146843,0.150848,0.154853,0.159882,0.164912,0.169941,0.174971,0.180000,0.264000,0.348000,0.432000,0.516000,0.600000]),
'z':array('d',[300.000000,315.777863,331.555725,347.333618,363.111481,378.889343,384.876709,390.864105,396.851471,402.838867,408.826233,414.029602,419.233002,424.436371,429.639771,434.843140,439.829315,444.815491,449.801636,454.787811,459.773987,464.885437,469.996918,475.108368,480.219849,485.331299,490.945984,496.560638,502.175323,507.789978,513.404663,520.126099,526.847534,533.568970,540.290405,547.011841,556.149109,565.286438,574.423706,583.561035,592.698303,608.378784,624.059204,639.739685,655.420105,671.100586,936.880493,1202.660400,1468.440186,1734.220093,2000.000000])},
't2_muplus_WJets_CR':{'x':array('d',[-1.000000,-0.920000,-0.840000,-0.760000,-0.680000,-0.600000,-0.560000,-0.520000,-0.480000,-0.440000,-0.400000,-0.360000,-0.320000,-0.280000,-0.240000,-0.200000,-0.160000,-0.120000,-0.080000,-0.040000,0.000000,0.040000,0.080000,0.120000,0.160000,0.200000,0.240000,0.280000,0.320000,0.360000,0.400000,0.440000,0.480000,0.520000,0.560000,0.600000,0.680000,0.760000,0.840000,0.920000,1.000000]),
'y':array('d',[0.000000,0.013570,0.027139,0.040709,0.054278,0.067848,0.075792,0.083736,0.091681,0.099625,0.107569,0.116189,0.124809,0.133429,0.142049,0.150669,0.160535,0.170401,0.180268,0.190134,0.200000,0.280000,0.360000,0.440000,0.520000,0.600000]),
'z':array('d',[300.000000,361.532837,423.065674,484.598511,546.131348,607.664185,624.207886,640.751648,657.295349,673.839111,690.382812,710.087036,729.791260,749.495483,769.199707,788.903931,820.706848,852.509766,884.312683,916.115601,947.918518,1358.334839,1768.751099,2179.167480,2589.583740,3000.000000])},
't3_elplus_SR':{'x':array('d',[-1.000000,-0.980000,-0.960000,-0.940000,-0.920000,-0.900000,-0.880000,-0.860000,-0.840000,-0.820000,-0.800000,-0.780000,-0.760000,-0.740000,-0.720000,-0.700000,-0.680000,-0.660000,-0.640000,-0.620000,-0.600000,-0.580000,-0.560000,-0.540000,-0.520000,-0.500000,-0.480000,-0.460000,-0.440000,-0.420000,-0.400000,-0.380000,-0.360000,-0.340000,-0.320000,-0.300000,-0.280000,-0.260000,-0.240000,-0.220000,-0.200000,-0.180000,-0.160000,-0.140000,-0.120000,-0.100000,-0.080000,-0.060000,-0.040000,-0.020000,0.000000,0.020000,0.040000,0.060000,0.080000,0.100000,0.120000,0.140000,0.160000,0.180000,0.200000,0.220000,0.240000,0.260000,0.280000,0.300000,0.320000,0.340000,0.360000,0.380000,0.400000,0.420000,0.440000,0.460000,0.480000,0.500000,0.520000,0.540000,0.560000,0.580000,0.600000,0.620000,0.640000,0.660000,0.680000,0.700000,0.720000,0.740000,0.760000,0.780000,0.800000,0.820000,0.840000,0.860000,0.880000,0.900000,0.920000,0.940000,0.960000,0.980000,1.000000]),
'y':array('d',[0.000000,0.005940,0.011880,0.017820,0.023760,0.029700,0.033455,0.037210,0.040964,0.044719,0.048474,0.051924,0.055375,0.058825,0.062276,0.065726,0.068776,0.071825,0.074875,0.077924,0.080974,0.083962,0.086950,0.089938,0.092926,0.095914,0.100201,0.104488,0.108774,0.113061,0.117348,0.121656,0.125965,0.130273,0.134582,0.138890,0.143626,0.148362,0.153099,0.157835,0.162571,0.166057,0.169543,0.173028,0.176514,0.180000,0.264000,0.348000,0.432000,0.516000,0.600000]),
'z':array('d',[300.000000,316.227539,332.455109,348.682648,364.910217,381.137756,387.180908,393.224030,399.267181,405.310303,411.353455,416.532166,421.710876,426.889587,432.068298,437.247009,442.266144,447.285278,452.304382,457.323517,462.342651,467.413086,472.483551,477.553986,482.624451,487.694885,493.459717,499.224518,504.989349,510.754150,516.518982,523.311523,530.104126,536.896667,543.689270,550.481812,559.625793,568.769775,577.913696,587.057678,596.201660,611.994019,627.786316,643.578674,659.370972,675.163330,940.130676,1205.098022,1470.065308,1735.032715,2000.000000])},
't1_elplus_SR':{'x':array('d',[-1.000000,-0.900000,-0.800000,-0.700000,-0.600000,-0.500000,-0.450000,-0.400000,-0.350000,-0.300000,-0.250000,-0.200000,-0.150000,-0.100000,-0.050000,0.000000,0.050000,0.100000,0.150000,0.200000,0.250000,0.300000,0.350000,0.400000,0.450000,0.500000,0.600000,0.700000,0.800000,0.900000,1.000000]),
'y':array('d',[0.000000,0.032214,0.064428,0.096641,0.128855,0.161069,0.188855,0.216641,0.244428,0.272214,0.300000,0.360000,0.420000,0.480000,0.540000,0.600000]),
'z':array('d',[500.000000,635.343628,770.687195,906.030823,1041.374390,1176.718018,1541.374390,1906.030762,2270.687256,2635.343506,3000.000000])},
't1_muplus_WJets_CR':{'x':array('d',[-1.000000,-0.900000,-0.800000,-0.700000,-0.600000,-0.500000,-0.450000,-0.400000,-0.350000,-0.300000,-0.250000,-0.200000,-0.150000,-0.100000,-0.050000,0.000000,0.050000,0.100000,0.150000,0.200000,0.250000,0.300000,0.350000,0.400000,0.450000,0.500000,0.600000,0.700000,0.800000,0.900000,1.000000]),
'y':array('d',[0.000000,0.027992,0.055984,0.083976,0.111968,0.139960,0.171968,0.203976,0.235984,0.267992,0.300000,0.360000,0.420000,0.480000,0.540000,0.600000]),
'z':array('d',[500.000000,588.286499,676.572998,764.859436,853.145935,941.432434,1353.145996,1764.859497,2176.572998,2588.286377,3000.000000])},
't2_elminus_WJets_CR':{'x':array('d',[-1.000000,-0.920000,-0.840000,-0.760000,-0.680000,-0.600000,-0.560000,-0.520000,-0.480000,-0.440000,-0.400000,-0.360000,-0.320000,-0.280000,-0.240000,-0.200000,-0.160000,-0.120000,-0.080000,-0.040000,0.000000,0.040000,0.080000,0.120000,0.160000,0.200000,0.240000,0.280000,0.320000,0.360000,0.400000,0.440000,0.480000,0.520000,0.560000,0.600000,0.680000,0.760000,0.840000,0.920000,1.000000]),
'y':array('d',[0.000000,0.017096,0.034192,0.051288,0.068384,0.085480,0.095570,0.105659,0.115749,0.125838,0.135928,0.142065,0.148203,0.154340,0.160478,0.166615,0.173292,0.179969,0.186646,0.193323,0.200000,0.280000,0.360000,0.440000,0.520000,0.600000]),
'z':array('d',[300.000000,377.107208,454.214417,531.321655,608.428833,685.536072,709.949951,734.363831,758.777771,783.191650,807.605530,837.475464,867.345398,897.215271,927.085205,956.955139,1008.054443,1059.153687,1110.253052,1161.352295,1212.451660,1569.961304,1927.470947,2284.980713,2642.490234,3000.000000])},
't3_elminus_SR':{'x':array('d',[-1.000000,-0.980000,-0.960000,-0.940000,-0.920000,-0.900000,-0.880000,-0.860000,-0.840000,-0.820000,-0.800000,-0.780000,-0.760000,-0.740000,-0.720000,-0.700000,-0.680000,-0.660000,-0.640000,-0.620000,-0.600000,-0.580000,-0.560000,-0.540000,-0.520000,-0.500000,-0.480000,-0.460000,-0.440000,-0.420000,-0.400000,-0.380000,-0.360000,-0.340000,-0.320000,-0.300000,-0.280000,-0.260000,-0.240000,-0.220000,-0.200000,-0.180000,-0.160000,-0.140000,-0.120000,-0.100000,-0.080000,-0.060000,-0.040000,-0.020000,0.000000,0.020000,0.040000,0.060000,0.080000,0.100000,0.120000,0.140000,0.160000,0.180000,0.200000,0.220000,0.240000,0.260000,0.280000,0.300000,0.320000,0.340000,0.360000,0.380000,0.400000,0.420000,0.440000,0.460000,0.480000,0.500000,0.520000,0.540000,0.560000,0.580000,0.600000,0.620000,0.640000,0.660000,0.680000,0.700000,0.720000,0.740000,0.760000,0.780000,0.800000,0.820000,0.840000,0.860000,0.880000,0.900000,0.920000,0.940000,0.960000,0.980000,1.000000]),
'y':array('d',[0.000000,0.003554,0.007107,0.010661,0.014214,0.017768,0.021611,0.025455,0.029298,0.033142,0.036985,0.040322,0.043659,0.046996,0.050333,0.053670,0.056976,0.060281,0.063587,0.066892,0.070198,0.073432,0.076666,0.079900,0.083134,0.086368,0.090011,0.093654,0.097298,0.100941,0.104584,0.109343,0.114101,0.118860,0.123618,0.128377,0.133031,0.137685,0.142340,0.146994,0.151648,0.157318,0.162989,0.168659,0.174330,0.180000,0.264000,0.348000,0.432000,0.516000,0.600000]),
'z':array('d',[300.000000,316.194580,332.389130,348.583710,364.778259,380.972839,387.004517,393.036224,399.067902,405.099609,411.131287,416.312836,421.494385,426.675964,431.857513,437.039062,442.035828,447.032593,452.029358,457.026123,462.022888,467.205780,472.388641,477.571533,482.754395,487.937286,493.657013,499.376740,505.096436,510.816162,516.535889,523.415649,530.295410,537.175110,544.054871,550.934631,560.060303,569.185913,578.311584,587.437195,596.562866,612.080505,627.598145,643.115845,658.633484,674.151123,939.320923,1204.490723,1469.660400,1734.830200,2000.000000])},
't3_muminus_SR':{'x':array('d',[-1.000000,-0.980000,-0.960000,-0.940000,-0.920000,-0.900000,-0.880000,-0.860000,-0.840000,-0.820000,-0.800000,-0.780000,-0.760000,-0.740000,-0.720000,-0.700000,-0.680000,-0.660000,-0.640000,-0.620000,-0.600000,-0.580000,-0.560000,-0.540000,-0.520000,-0.500000,-0.480000,-0.460000,-0.440000,-0.420000,-0.400000,-0.380000,-0.360000,-0.340000,-0.320000,-0.300000,-0.280000,-0.260000,-0.240000,-0.220000,-0.200000,-0.180000,-0.160000,-0.140000,-0.120000,-0.100000,-0.080000,-0.060000,-0.040000,-0.020000,0.000000,0.020000,0.040000,0.060000,0.080000,0.100000,0.120000,0.140000,0.160000,0.180000,0.200000,0.220000,0.240000,0.260000,0.280000,0.300000,0.320000,0.340000,0.360000,0.380000,0.400000,0.420000,0.440000,0.460000,0.480000,0.500000,0.520000,0.540000,0.560000,0.580000,0.600000,0.620000,0.640000,0.660000,0.680000,0.700000,0.720000,0.740000,0.760000,0.780000,0.800000,0.820000,0.840000,0.860000,0.880000,0.900000,0.920000,0.940000,0.960000,0.980000,1.000000]),
'y':array('d',[0.000000,0.004534,0.009067,0.013601,0.018134,0.022668,0.025996,0.029325,0.032653,0.035982,0.039310,0.042354,0.045397,0.048441,0.051484,0.054528,0.057551,0.060574,0.063597,0.066620,0.069643,0.072425,0.075207,0.077990,0.080772,0.083554,0.087503,0.091451,0.095400,0.099348,0.103297,0.107885,0.112473,0.117061,0.121649,0.126237,0.130822,0.135407,0.139992,0.144577,0.149162,0.155330,0.161497,0.167665,0.173832,0.180000,0.264000,0.348000,0.432000,0.516000,0.600000]),
'z':array('d',[300.000000,315.877869,331.755737,347.633636,363.511505,379.389374,385.270966,391.152557,397.034149,402.915741,408.797333,414.031097,419.264832,424.498596,429.732330,434.966095,439.853088,444.740082,449.627106,454.514099,459.401093,464.514374,469.627655,474.740967,479.854248,484.967529,490.597290,496.227020,501.856781,507.486511,513.116272,519.811462,526.506653,533.201904,539.897095,546.592285,555.672302,564.752319,573.832397,582.912415,591.992432,607.611511,623.230591,638.849670,654.468750,670.087830,936.070251,1202.052734,1468.035156,1734.017578,2000.000000])},
't1_elminus_SR':{'x':array('d',[-1.000000,-0.900000,-0.800000,-0.700000,-0.600000,-0.500000,-0.450000,-0.400000,-0.350000,-0.300000,-0.250000,-0.200000,-0.150000,-0.100000,-0.050000,0.000000,0.050000,0.100000,0.150000,0.200000,0.250000,0.300000,0.350000,0.400000,0.450000,0.500000,0.600000,0.700000,0.800000,0.900000,1.000000]),
'y':array('d',[0.000000,0.032473,0.064946,0.097418,0.129891,0.162364,0.189891,0.217418,0.244946,0.272473,0.300000,0.360000,0.420000,0.480000,0.540000,0.600000]),
'z':array('d',[500.000000,636.041626,772.083313,908.124939,1044.166626,1180.208252,1544.166626,1908.125000,2272.083252,2636.041748,3000.000000])},
't2_muminus_WJets_CR':{'x':array('d',[-1.000000,-0.920000,-0.840000,-0.760000,-0.680000,-0.600000,-0.560000,-0.520000,-0.480000,-0.440000,-0.400000,-0.360000,-0.320000,-0.280000,-0.240000,-0.200000,-0.160000,-0.120000,-0.080000,-0.040000,0.000000,0.040000,0.080000,0.120000,0.160000,0.200000,0.240000,0.280000,0.320000,0.360000,0.400000,0.440000,0.480000,0.520000,0.560000,0.600000,0.680000,0.760000,0.840000,0.920000,1.000000]),
'y':array('d',[0.000000,0.015022,0.030045,0.045067,0.060090,0.075112,0.084386,0.093660,0.102935,0.112209,0.121483,0.129196,0.136909,0.144621,0.152334,0.160047,0.168038,0.176028,0.184019,0.192009,0.200000,0.280000,0.360000,0.440000,0.520000,0.600000]),
'z':array('d',[300.000000,360.887451,421.774933,482.662384,543.549866,604.437317,621.486755,638.536133,655.585571,672.634949,689.684387,709.344482,729.004517,748.664612,768.324646,787.984741,819.566223,851.147705,882.729248,914.310730,945.892212,1356.713745,1767.535278,2178.356934,2589.178467,3000.000000])},
't2_elplus_SR':{'x':array('d',[-1.000000,-0.920000,-0.840000,-0.760000,-0.680000,-0.600000,-0.560000,-0.520000,-0.480000,-0.440000,-0.400000,-0.360000,-0.320000,-0.280000,-0.240000,-0.200000,-0.160000,-0.120000,-0.080000,-0.040000,0.000000,0.040000,0.080000,0.120000,0.160000,0.200000,0.240000,0.280000,0.320000,0.360000,0.400000,0.440000,0.480000,0.520000,0.560000,0.600000,0.680000,0.760000,0.840000,0.920000,1.000000]),
'y':array('d',[0.000000,0.009444,0.018889,0.028333,0.037778,0.047222,0.060652,0.074082,0.087513,0.100943,0.114373,0.123647,0.132920,0.142194,0.151467,0.160741,0.168593,0.176445,0.184296,0.192148,0.200000,0.280000,0.360000,0.440000,0.520000,0.600000]),
'z':array('d',[300.000000,358.557495,417.115021,475.672516,534.230042,592.787537,625.221375,657.655212,690.088989,722.522827,754.956665,781.031799,807.106934,833.182129,859.257263,885.332397,919.766418,954.200439,988.634399,1023.068420,1057.502441,1446.001953,1834.501465,2223.000977,2611.500488,3000.000000])},
't1_muplus_SR':{'x':array('d',[-1.000000,-0.900000,-0.800000,-0.700000,-0.600000,-0.500000,-0.450000,-0.400000,-0.350000,-0.300000,-0.250000,-0.200000,-0.150000,-0.100000,-0.050000,0.000000,0.050000,0.100000,0.150000,0.200000,0.250000,0.300000,0.350000,0.400000,0.450000,0.500000,0.600000,0.700000,0.800000,0.900000,1.000000]),
'y':array('d',[0.000000,0.026493,0.052987,0.079480,0.105974,0.132467,0.165974,0.199480,0.232987,0.266493,0.300000,0.360000,0.420000,0.480000,0.540000,0.600000]),
'z':array('d',[500.000000,621.673218,743.346375,865.019592,986.692749,1108.365967,1486.692749,1865.019531,2243.346436,2621.673096,3000.000000])},
't2_elminus_SR':{'x':array('d',[-1.000000,-0.920000,-0.840000,-0.760000,-0.680000,-0.600000,-0.560000,-0.520000,-0.480000,-0.440000,-0.400000,-0.360000,-0.320000,-0.280000,-0.240000,-0.200000,-0.160000,-0.120000,-0.080000,-0.040000,0.000000,0.040000,0.080000,0.120000,0.160000,0.200000,0.240000,0.280000,0.320000,0.360000,0.400000,0.440000,0.480000,0.520000,0.560000,0.600000,0.680000,0.760000,0.840000,0.920000,1.000000]),
'y':array('d',[0.000000,0.006045,0.012090,0.018135,0.024180,0.030225,0.041016,0.051807,0.062599,0.073390,0.084181,0.098083,0.111985,0.125888,0.139790,0.153692,0.162954,0.172215,0.181477,0.190738,0.200000,0.280000,0.360000,0.440000,0.520000,0.600000]),
'z':array('d',[300.000000,358.262756,416.525482,474.788239,533.050964,591.313721,626.475342,661.636963,696.798523,731.960144,767.121765,794.475098,821.828491,849.181824,876.535217,903.888550,936.885742,969.882935,1002.880127,1035.877319,1068.874512,1455.099609,1841.324707,2227.549805,2613.774902,3000.000000])},
't1_elminus_WJets_CR':{'x':array('d',[-1.000000,-0.900000,-0.800000,-0.700000,-0.600000,-0.500000,-0.450000,-0.400000,-0.350000,-0.300000,-0.250000,-0.200000,-0.150000,-0.100000,-0.050000,0.000000,0.050000,0.100000,0.150000,0.200000,0.250000,0.300000,0.350000,0.400000,0.450000,0.500000,0.600000,0.700000,0.800000,0.900000,1.000000]),
'y':array('d',[0.000000,0.029054,0.058107,0.087161,0.116214,0.145268,0.176214,0.207161,0.238107,0.269054,0.300000,0.360000,0.420000,0.480000,0.540000,0.600000]),
'z':array('d',[500.000000,612.825806,725.651672,838.477478,951.303345,1064.129150,1451.303345,1838.477539,2225.651611,2612.825928,3000.000000])},
't1_elplus_WJets_CR':{'x':array('d',[-1.000000,-0.900000,-0.800000,-0.700000,-0.600000,-0.500000,-0.450000,-0.400000,-0.350000,-0.300000,-0.250000,-0.200000,-0.150000,-0.100000,-0.050000,0.000000,0.050000,0.100000,0.150000,0.200000,0.250000,0.300000,0.350000,0.400000,0.450000,0.500000,0.600000,0.700000,0.800000,0.900000,1.000000]),
'y':array('d',[0.000000,0.028272,0.056543,0.084815,0.113086,0.141358,0.173086,0.204815,0.236543,0.268272,0.300000,0.360000,0.420000,0.480000,0.540000,0.600000]),
'z':array('d',[500.000000,614.928406,729.856812,844.785156,959.713562,1074.641968,1459.713623,1844.785156,2229.856689,2614.928467,3000.000000])},
't2_muminus_SR':{'x':array('d',[-1.000000,-0.920000,-0.840000,-0.760000,-0.680000,-0.600000,-0.560000,-0.520000,-0.480000,-0.440000,-0.400000,-0.360000,-0.320000,-0.280000,-0.240000,-0.200000,-0.160000,-0.120000,-0.080000,-0.040000,0.000000,0.040000,0.080000,0.120000,0.160000,0.200000,0.240000,0.280000,0.320000,0.360000,0.400000,0.440000,0.480000,0.520000,0.560000,0.600000,0.680000,0.760000,0.840000,0.920000,1.000000]),
'y':array('d',[0.000000,0.013656,0.027312,0.040967,0.054623,0.068279,0.078853,0.089427,0.100002,0.110576,0.121150,0.130302,0.139455,0.148607,0.157760,0.166912,0.173530,0.180147,0.186765,0.193382,0.200000,0.280000,0.360000,0.440000,0.520000,0.600000]),
'z':array('d',[300.000000,353.259949,406.519928,459.779877,513.039856,566.299805,585.033752,603.767761,622.501709,641.235718,659.969666,678.752258,697.534851,716.317383,735.099976,753.882568,779.599915,805.317261,831.034546,856.751892,882.469238,1305.975342,1729.481567,2152.987793,2576.493896,3000.000000])},
't1_muminus_SR':{'x':array('d',[-1.000000,-0.900000,-0.800000,-0.700000,-0.600000,-0.500000,-0.450000,-0.400000,-0.350000,-0.300000,-0.250000,-0.200000,-0.150000,-0.100000,-0.050000,0.000000,0.050000,0.100000,0.150000,0.200000,0.250000,0.300000,0.350000,0.400000,0.450000,0.500000,0.600000,0.700000,0.800000,0.900000,1.000000]),
'y':array('d',[0.000000,0.030002,0.060004,0.090005,0.120007,0.150009,0.180007,0.210005,0.240004,0.270002,0.300000,0.360000,0.420000,0.480000,0.540000,0.600000]),
'z':array('d',[500.000000,621.365845,742.731628,864.097473,985.463257,1106.829102,1485.463257,1864.097412,2242.731689,2621.365723,3000.000000])},
't2_muplus_SR':{'x':array('d',[-1.000000,-0.920000,-0.840000,-0.760000,-0.680000,-0.600000,-0.560000,-0.520000,-0.480000,-0.440000,-0.400000,-0.360000,-0.320000,-0.280000,-0.240000,-0.200000,-0.160000,-0.120000,-0.080000,-0.040000,0.000000,0.040000,0.080000,0.120000,0.160000,0.200000,0.240000,0.280000,0.320000,0.360000,0.400000,0.440000,0.480000,0.520000,0.560000,0.600000,0.680000,0.760000,0.840000,0.920000,1.000000]),
'y':array('d',[0.000000,0.013888,0.027776,0.041664,0.055552,0.069440,0.079630,0.089819,0.100009,0.110198,0.120388,0.127240,0.134091,0.140943,0.147794,0.154646,0.163717,0.172788,0.181858,0.190929,0.200000,0.280000,0.360000,0.440000,0.520000,0.600000]),
'z':array('d',[300.000000,352.637207,405.274414,457.911621,510.548828,563.186035,582.313843,601.441650,620.569397,639.697205,658.825012,677.831055,696.837097,715.843201,734.849243,753.855286,780.664124,807.472961,834.281738,861.090576,887.899414,1310.319580,1732.739624,2155.159668,2577.579834,3000.000000])},
't2_elplus_WJets_CR':{'x':array('d',[-1.000000,-0.920000,-0.840000,-0.760000,-0.680000,-0.600000,-0.560000,-0.520000,-0.480000,-0.440000,-0.400000,-0.360000,-0.320000,-0.280000,-0.240000,-0.200000,-0.160000,-0.120000,-0.080000,-0.040000,0.000000,0.040000,0.080000,0.120000,0.160000,0.200000,0.240000,0.280000,0.320000,0.360000,0.400000,0.440000,0.480000,0.520000,0.560000,0.600000,0.680000,0.760000,0.840000,0.920000,1.000000]),
'y':array('d',[0.000000,0.019345,0.038690,0.058035,0.077380,0.096725,0.103355,0.109984,0.116614,0.123243,0.129873,0.136242,0.142611,0.148981,0.155350,0.161719,0.169375,0.177031,0.184688,0.192344,0.200000,0.280000,0.360000,0.440000,0.520000,0.600000]),
'z':array('d',[300.000000,378.528381,457.056793,535.585205,614.113586,692.641968,717.816101,742.990295,768.164429,793.338623,818.512756,846.377014,874.241272,902.105530,929.969788,957.834045,1008.338440,1058.842773,1109.347168,1159.851562,1210.355957,1568.284790,1926.213623,2284.142334,2642.071289,3000.000000])},
't1_muminus_WJets_CR':{'x':array('d',[-1.000000,-0.900000,-0.800000,-0.700000,-0.600000,-0.500000,-0.450000,-0.400000,-0.350000,-0.300000,-0.250000,-0.200000,-0.150000,-0.100000,-0.050000,0.000000,0.050000,0.100000,0.150000,0.200000,0.250000,0.300000,0.350000,0.400000,0.450000,0.500000,0.600000,0.700000,0.800000,0.900000,1.000000]),
'y':array('d',[0.000000,0.024222,0.048445,0.072667,0.096890,0.121112,0.156890,0.192667,0.228445,0.264222,0.300000,0.360000,0.420000,0.480000,0.540000,0.600000]),
'z':array('d',[500.000000,588.135620,676.271301,764.406921,852.542603,940.678223,1352.542603,1764.406982,2176.271240,2588.135742,3000.000000])},
}

BINS_COARSE = {
#type-3
't3_muplus_SR':{'x':array('d',[-1.000000,-0.900000,-0.800000,-0.700000,-0.600000,-0.500000,-0.400000,-0.300000,-0.200000,-0.100000,0.000000,0.100000,0.200000,0.300000,0.400000,0.500000,0.600000,0.700000,0.800000,0.900000,1.000000]),
'y':array('d',[0.000000,0.026134,0.046960,0.062639,0.078182,0.096256,0.114598,0.134829,0.154853,0.180000,0.600000]),
'z':array('d',[300.000000,378.889343,408.826233,434.843140,459.773987,485.331299,513.404663,547.011841,592.698303,671.100586,2000.000000])},
't3_muminus_SR':{'x':array('d',[-1.000000,-0.900000,-0.800000,-0.700000,-0.600000,-0.500000,-0.400000,-0.300000,-0.200000,-0.100000,0.000000,0.100000,0.200000,0.300000,0.400000,0.500000,0.600000,0.700000,0.800000,0.900000,1.000000]),
'y':array('d',[0.000000,0.022668,0.039310,0.054528,0.069643,0.083554,0.103297,0.126237,0.149162,0.180000,0.600000]),
'z':array('d',[300.000000,379.389374,408.797333,434.966095,459.401093,484.967529,513.116272,546.592285,591.992432,670.087830,2000.000000])},
't3_elplus_SR':{'x':array('d',[-1.000000,-0.900000,-0.800000,-0.700000,-0.600000,-0.500000,-0.400000,-0.300000,-0.200000,-0.100000,0.000000,0.100000,0.200000,0.300000,0.400000,0.500000,0.600000,0.700000,0.800000,0.900000,1.000000]),
'y':array('d',[0.000000,0.029700,0.048474,0.065726,0.080974,0.095914,0.117348,0.138890,0.162571,0.180000,0.600000]),
'z':array('d',[300.000000,381.137756,411.353455,437.247009,462.342651,487.694885,516.518982,550.481812,596.201660,675.163330,2000.000000])},
't3_elminus_SR':{'x':array('d',[-1.000000,-0.900000,-0.800000,-0.700000,-0.600000,-0.500000,-0.400000,-0.300000,-0.200000,-0.100000,0.000000,0.100000,0.200000,0.300000,0.400000,0.500000,0.600000,0.700000,0.800000,0.900000,1.000000]),
'y':array('d',[0.000000,0.017768,0.036985,0.053670,0.070198,0.086368,0.104584,0.128377,0.151648,0.180000,0.600000]),
'z':array('d',[300.000000,380.972839,411.131287,437.039062,462.022888,487.937286,516.535889,550.934631,596.562866,674.151123,2000.000000])},
#type-2 signal region
't2_muplus_SR':{'x':array('d',[-1.000000,-0.600000,-0.400000,-0.200000,0.000000,0.200000,0.400000,0.600000,1.000000]),
'y':array('d',[0.000000,0.069440,0.120388,0.154646,0.200000,0.600000]),
'z':array('d',[300.000000,563.186035,658.825012,753.855286,887.899414,3000.000000])},
't2_muminus_SR':{'x':array('d',[-1.000000,-0.600000,-0.400000,-0.200000,0.000000,0.200000,0.400000,0.600000,1.000000]),
'y':array('d',[0.000000,0.068279,0.121150,0.166912,0.200000,0.600000]),
'z':array('d',[300.000000,566.299805,659.969666,753.882568,882.469238,3000.000000])},
't2_elplus_SR':{'x':array('d',[-1.000000,-0.600000,-0.400000,-0.200000,0.000000,0.200000,0.400000,0.600000,1.000000]),
'y':array('d',[0.000000,0.047222,0.114373,0.160741,0.200000,0.600000]),
'z':array('d',[300.000000,592.787537,754.956665,885.332397,1057.502441,3000.000000])},
't2_elminus_SR':{'x':array('d',[-1.000000,-0.600000,-0.400000,-0.200000,0.000000,0.200000,0.400000,0.600000,1.000000]),
'y':array('d',[0.000000,0.030225,0.084181,0.153692,0.200000,0.600000]),
'z':array('d',[300.000000,591.313721,767.121765,903.888550,1068.874512,3000.000000])},
#type-2 control region
't2_muplus_WJets_CR':{'x':array('d',[-1.000000,-0.600000,-0.400000,-0.200000,0.000000,0.200000,0.400000,0.600000,1.000000]),
'y':array('d',[0.000000,0.067848,0.107569,0.150669,0.200000,0.600000]),
'z':array('d',[300.000000,607.664185,690.382812,788.903931,947.918518,3000.000000])},
't2_muminus_WJets_CR':{'x':array('d',[-1.000000,-0.600000,-0.400000,-0.200000,0.000000,0.200000,0.400000,0.600000,1.000000]),
'y':array('d',[0.000000,0.075112,0.121483,0.160047,0.200000,0.600000]),
'z':array('d',[300.000000,604.437317,689.684387,787.984741,945.892212,3000.000000])},
't2_elplus_WJets_CR':{'x':array('d',[-1.000000,-0.600000,-0.400000,-0.200000,0.000000,0.200000,0.400000,0.600000,1.000000]),
'y':array('d',[0.000000,0.096725,0.129873,0.161719,0.200000,0.600000]),
'z':array('d',[300.000000,692.641968,818.512756,957.834045,1210.355957,3000.000000])},
't2_elminus_WJets_CR':{'x':array('d',[-1.000000,-0.600000,-0.400000,-0.200000,0.000000,0.200000,0.400000,0.600000,1.000000]),
'y':array('d',[0.000000,0.085480,0.135928,0.166615,0.200000,0.600000]),
'z':array('d',[300.000000,685.536072,807.605530,956.955139,1212.451660,3000.000000])},
#type-1 signal region
't1_muplus_SR':{'x':array('d',[-1.000000,-0.500000,-0.250000,0.000000,0.250000,0.500000,1.000000]),
'y':array('d',[0.000000,0.132467,0.300000,0.600000]),
'z':array('d',[500.000000,1108.365967,3000.000000])},
't1_muminus_SR':{'x':array('d',[-1.000000,-0.500000,-0.250000,0.000000,0.250000,0.500000,1.000000]),
'y':array('d',[0.000000,0.150009,0.300000,0.600000]),
'z':array('d',[500.000000,1106.829102,3000.000000])},
't1_elplus_SR':{'x':array('d',[-1.000000,-0.500000,-0.250000,0.000000,0.250000,0.500000,1.000000]),
'y':array('d',[0.000000,0.161069,0.300000,0.600000]),
'z':array('d',[500.000000,1176.718018,3000.000000])},
't1_elminus_SR':{'x':array('d',[-1.000000,-0.500000,-0.250000,0.000000,0.250000,0.500000,1.000000]),
'y':array('d',[0.000000,0.162364,0.300000,0.600000]),
'z':array('d',[500.000000,1180.208252,3000.000000])},
#type-1 control region
't1_muplus_WJets_CR':{'x':array('d',[-1.000000,-0.500000,-0.250000,0.000000,0.250000,0.500000,1.000000]),
'y':array('d',[0.000000,0.139960,0.300000,0.600000]),
'z':array('d',[500.000000,941.432434,3000.000000])},
't1_muminus_WJets_CR':{'x':array('d',[-1.000000,-0.500000,-0.250000,0.000000,0.250000,0.500000,1.000000]),
'y':array('d',[0.000000,0.121112,0.300000,0.600000]),
'z':array('d',[500.000000,940.678223,3000.000000])},
't1_elplus_WJets_CR':{'x':array('d',[-1.000000,-0.500000,-0.250000,0.000000,0.250000,0.500000,1.000000]),
'y':array('d',[0.000000,0.141358,0.300000,0.600000]),
'z':array('d',[500.000000,1074.641968,3000.000000])},
't1_elminus_WJets_CR':{'x':array('d',[-1.000000,-0.500000,-0.250000,0.000000,0.250000,0.500000,1.000000]),
'y':array('d',[0.000000,0.145268,0.300000,0.600000]),
'z':array('d',[500.000000,1064.129150,3000.000000])},
}

#Template class
class Template(object) :

	def __init__(self,name,formatted_name,modifier,binning='fine') :
		#A Template has a name and a formatted name
		#print '	Adding template with name '+name
		self.__name = name
		self.__type = 'nominal'
		if len(name.split('__'))==3 :
			self.__type = name.split('__')[2]
		self.__formatted_name = formatted_name
		#Templates have modifiers associated with them
		self.__modifier = modifier
		#Dictionary of weightsums for function replacements
		self.__weightsum_dict = {'NQQBAR':{'wname':None,'sig':0.,'qcd_a':0.,'qcd_b':0.,'qcd_c':0.},
								 'NQ1':{'wname':'wqs1','sig':0.,'qcd_a':0.,'qcd_b':0.,'qcd_c':0.},
								 'NQ2':{'wname':'wqs2','sig':0.,'qcd_a':0.,'qcd_b':0.,'qcd_c':0.},
								 'NGG':{'wname':None,'sig':0.,'qcd_a':0.,'qcd_b':0.,'qcd_c':0.},
								 'NG1':{'wname':'wg1','sig':0.,'qcd_a':0.,'qcd_b':0.,'qcd_c':0.},
								 'NG2':{'wname':'wg2','sig':0.,'qcd_a':0.,'qcd_b':0.,'qcd_c':0.},
								 'NG3':{'wname':'wg3','sig':0.,'qcd_a':0.,'qcd_b':0.,'qcd_c':0.},
								 'NG4':{'wname':'wg4','sig':0.,'qcd_a':0.,'qcd_b':0.,'qcd_c':0.},
								 'NBCK':{'wname':None,'sig':0.,'qcd_a':0.,'qcd_b':0.,'qcd_c':0.},
								 'NWJETS':{'wname':None,'sig':0.,'qcd_a':0.,'qcd_b':0.,'qcd_c':0.},
								 'NQCD':{'wname':None,'sig':0.,'qcd_a':0.,'qcd_b':0.,'qcd_c':0.}}
		#set the binning arrays based on the channel name
		if binning=='fine' :
			self._XBINS = copy.copy(BINS_FINE[self.__name.split('__')[0]]['x'])
			self._YBINS = copy.copy(BINS_FINE[self.__name.split('__')[0]]['y'])
			self._ZBINS = copy.copy(BINS_FINE[self.__name.split('__')[0]]['z'])
		elif binning=='coarse' :
			self._XBINS = copy.copy(BINS_COARSE[self.__name.split('__')[0]]['x'])
			self._YBINS = copy.copy(BINS_COARSE[self.__name.split('__')[0]]['y'])
			self._ZBINS = copy.copy(BINS_COARSE[self.__name.split('__')[0]]['z'])
		else :
			print 'ERROR: cannot determine which binning to use based on binning option %s'%(binning)
			return
		#QCD templates will eventually need a conversion factor
		self.__conversion_factor = None
		#Templates have 3D and 1D projection histograms
		self.__histo_3D = TH3D(name,formatted_name+'; c*; |x_{F}|; M (GeV)',len(self._XBINS)-1,self._XBINS,len(self._YBINS)-1,self._YBINS,len(self._ZBINS)-1,self._ZBINS)
		self.__histo_x  = TH1D(name+'_x',formatted_name+' X Projection; c*',len(self._XBINS)-1,self._XBINS)
		self.__histo_y  = TH1D(name+'_y',formatted_name+' Y Projection; |x_{F}|',len(self._YBINS)-1,self._YBINS)
		self.__histo_z  = TH1D(name+'_z',formatted_name+' Z Projection; M (GeV)',len(self._ZBINS)-1,self._ZBINS)
		#Set the directories of the newly created histograms
		self.__histo_3D.SetDirectory(0); self.__histo_x.SetDirectory(0); self.__histo_y.SetDirectory(0); self.__histo_z.SetDirectory(0)

	#get the event numbers for this process
	def buildWeightsums(self,ttree_dict,branch_dict,const_rw_name_list,ss_rw_name_list,JEC_append,channelcharge,ptfn) :
		#Make a list of weightsum names that we'll be building
		weightsum_names = []
		for name in self.__weightsum_dict :
			if self.__name.find('fqq')!=-1 :
				if name.find('NQ')!=-1 and name!='NQCD' :
					weightsum_names.append(name)
			elif self.__name.find('fgg')!=-1 :
				if name.find('NG')!=-1 :
					weightsum_names.append(name)
			elif self.__name.find('fbck')!=-1 :
				if name.find('NBCK')!=-1 :
					weightsum_names.append(name)
			elif self.__name.find('fwjets')!=-1 :
				if name.find('NWJETS')!=-1 :
					weightsum_names.append(name)
			elif self.__name.find('fqcd')!=-1 :
				if name.find('NQCD')!=-1 :
					weightsum_names.append(name)
		#Make a list of ttree identifiers
		ttree_identifiers = []
		for name in self.__weightsum_dict[weightsum_names[0]] :
			if name!='wname' :
				ttree_identifiers.append(name)
		#open each tree
		for identifier in ttree_identifiers :
			realidentifier = identifier+JEC_append
			filep = TFile(ptfn)
			tree = filep.Get(ttree_dict[realidentifier].GetName())
			#set branch addresses
			for branch in branch_dict.values() :
				tree.SetBranchAddress(branch.getPTreeName(),branch.getPTreeArray())
			#loop over entries
			nEntries = tree.GetEntries()
			for entry in range(nEntries) :
				tree.GetEntry(entry)
				#get event weight
				eweight = self.__get_event_weight__(branch_dict,const_rw_name_list,ss_rw_name_list,(identifier.find('qcd_b')!=-1 or identifier.find('qcd_c')!=-1))
				#for each weightsum we're making, apply the last remaining weight and then increment the value
				for weightsumname in weightsum_names :
					wname = self.__weightsum_dict[weightsumname]['wname']
					if channelcharge==0 :
						if wname==None :
							self.__weightsum_dict[weightsumname][identifier]+=2*eweight
						else :
							self.__weightsum_dict[weightsumname][identifier]+=eweight*branch_dict[wname].getPTreeValue()
							self.__weightsum_dict[weightsumname][identifier]+=eweight*branch_dict[wname+'_opp'].getPTreeValue()
					else :
						if wname==None :
							self.__weightsum_dict[weightsumname][identifier]+=eweight
						elif branch_dict['lep_Q'].getPTreeValue()==channelcharge :
							self.__weightsum_dict[weightsumname][identifier]+=eweight*branch_dict[wname].getPTreeValue()
						elif branch_dict['lep_Q'].getPTreeValue()!=channelcharge :
							self.__weightsum_dict[weightsumname][identifier]+=eweight*branch_dict[wname+'_opp'].getPTreeValue()
			filep.Close()

	#get the numbers of events in the regions specified by the keys of the event_numbers dictionary supplied
	def getEventNumbers(self,channelcharge,jecappend,ttree_dict,branch_dict,const_rw_name_list,ss_rw_list,event_numbers,function,fit_par_list,extra_weight,ptfn) :
		#for each region (and tree)
		for ttree_identifier in event_numbers :
			#First replace the total event numbers in the function
			functionstring = self.__replace_function_string__(ttree_identifier,function,fit_par_list)
			#loop over the tree
			realidentifier = ttree_identifier
			if jecappend!=None :
				realidentifier+=jecappend
			filep = TFile(ptfn)
			tree = filep.Get(ttree_dict[realidentifier].GetName())
			for branch in branch_dict.values() :
				tree.SetBranchAddress(branch.getPTreeName(),branch.getPTreeArray())
			nEntries = tree.GetEntries()
			for entry in range(nEntries) :
				#if entry==1 : print 'doing entry %d of %d for template with name %s'%(entry,nEntries,self.getName()) #DEBUG
				tree.GetEntry(entry)
				#get the event weight
				eweight = self.__get_event_weight__(branch_dict,const_rw_name_list,ss_rw_list,(ttree_identifier.find('qcd_b')!=-1 or ttree_identifier.find('qcd_c')!=-1),entry==1)
				eweight_opp = eweight
				#if entry==1 : print '	initial = %.4f'%(eweight) #DEBUG
				#multiply by the function weights if necessary
				if functionstring!=None and functionstring!='' :
					fweight, fweight_opp = self.__get_function_weight__(branch_dict,functionstring)
					eweight*=fweight; eweight_opp*=fweight_opp
				#if entry==1 : print '	after function weight = %.4f'%(eweight) #DEBUG
				#multiply by the last +/-1 factor or whatever
				eweight*=extra_weight; eweight_opp*=extra_weight
				#if entry==1 : print '	after extra weight = %.4f'%(eweight) #DEBUG
				#add to the event numbers
				if channelcharge==0 or branch_dict['lep_Q'].getPTreeValue()==channelcharge:
					event_numbers[ttree_identifier]+=eweight
				if branch_dict['addTwice'].getPTreeValue()==1 and (channelcharge==0 or branch_dict['lep_Q'].getPTreeValue()!=channelcharge) :
					event_numbers[ttree_identifier]+=eweight_opp
				#if entry==1 : print 'for template %s with realidentifier %s eweight for entry %d = %.6f'%(self.getName(),realidentifier,entry,eweight) #DEBUG
			filep.Close()
		return event_numbers

	#add the given tree to the template
	def addTreeToTemplates(self,channelcharge,ttree_identifier,tree,branch_dict,const_rw_name_list,ss_rw_list,function,fit_par_list,extra_weight,ptfn,pb) :
		#replace the total event numbers in the function
		functionstring = self.__replace_function_string__(ttree_identifier,function,fit_par_list)
		filep = TFile(ptfn)
		tree = filep.Get(tree.GetName())
		#loop over the tree
		for branch in branch_dict.values() :
			tree.SetBranchAddress(branch.getPTreeName(),branch.getPTreeArray())
		nEntries = tree.GetEntries()
#		added = 0 #DEBUG
#		n=0 #DEBUG
		for entry in range(nEntries) :
			if pb :
				percentdone = 100.*entry/nEntries
				if percentdone%1.<100./nEntries and percentdone%10.<((100.*(entry-1)/nEntries)%10.) :
					print '		%d%% done'%(percentdone)
#			n+=1 #DEBUG
			tree.GetEntry(entry)
			#get the event weight
			eweight = self.__get_event_weight__(branch_dict,const_rw_name_list,ss_rw_list,(ttree_identifier.find('qcd_b')!=-1 or ttree_identifier.find('qcd_c')!=-1))
#			s = 'event weight = '+str(eweight) #DEBUG
			#multiply by the function weights
			eweight_opp = eweight
			if functionstring!=None and functionstring!='' :
				fweight, fweight_opp = self.__get_function_weight__(branch_dict,functionstring)
				eweight*=fweight; eweight_opp*=fweight_opp
#				s+=', after func. weight = '+str(eweight) #DEBUG
			#if it has a conversion factor, apply it.
			if self.__conversion_factor!=None :
				eweight*=self.__conversion_factor; eweight_opp*=self.__conversion_factor
			#multiply by the last +/-1 factor from the function call
			eweight*=extra_weight; eweight_opp*=extra_weight
#			s+=', after extra weight = '+str(eweight) #DEBUG
			#add to the templates
			x = branch_dict['cstar'].getPTreeValue()
			y = abs(branch_dict['x_F'].getPTreeValue())
			z = branch_dict['M'].getPTreeValue()
			if channelcharge==0 or branch_dict['lep_Q'].getPTreeValue()==channelcharge:
				self.Fill(x,y,z,eweight)
#				added+=eweight #DEBUG
			if branch_dict['addTwice'].getPTreeValue()==1 and (channelcharge==0 or branch_dict['lep_Q'].getPTreeValue()==(-1*channelcharge)) :
				self.Fill(-1.0*x,y,z,eweight_opp)
#				added+=eweight_opp #DEBUG
#			s+=' (weightsum = '+str(added)+', n = '+str(n)+')' #DEBUG
#			print s #DEBUG
#		print 'TEMPLATE '+self.__name+' INTEGRAL = '+str(self.__histo_3D.Integral())+' (total weight added = '+str(added)+')' #DEBUG

	def fixNQCDValues(self) :
		value = self.__histo_3D.Integral()
		print '		Signal region NQCD for template '+self.__name+' = '+str(value)
		return value
	def setNQCDValue(self,value) :
		self.__weightsum_dict['NQCD']['sig']=value

	#Fill the histograms given x, y, and z values
	def Fill(self,x,y,z,w) :
		inxbounds = x>=self._XBINS[0] and x<self._XBINS[len(self._XBINS)-1]
		inybounds = y>=self._YBINS[0] and y<self._YBINS[len(self._YBINS)-1]
		inzbounds = z>=self._ZBINS[0] and z<self._ZBINS[len(self._ZBINS)-1]
		if inxbounds and inybounds and inzbounds :
			self.__histo_3D.Fill(x,y,z,w)
			self.__histo_x.Fill(x,w)
			self.__histo_y.Fill(y,w)
			self.__histo_z.Fill(z,w)

	#convertTo1D takes a 3D distribution and makes it 1D for use with combine
	def convertTo1D(self,bins_to_zero=None,nom_1D_histo=None) :
		nBins = self.__histo_3D.GetNbinsX()*self.__histo_3D.GetNbinsY()*self.__histo_3D.GetNbinsZ()
		newHisto = TH1D(self.__histo_3D.GetName(),self.__histo_3D.GetTitle(),nBins,0.,nBins-1.)
		newHisto.SetDirectory(0)
		realbincounter = 1
		nglobalbins = self.__histo_3D.GetSize()
		for k in range(nglobalbins) :
			if not self.__histo_3D.IsBinOverflow(k) and not self.__histo_3D.IsBinUnderflow(k) :
				if not self.__histo_3D.GetBinContent(k) < 0. :
					newHisto.SetBinContent(realbincounter,self.__histo_3D.GetBinContent(k))
					if self.__histo_3D.GetBinContent(k)-self.__histo_3D.GetBinError(k)<0. :
						newHisto.SetBinError(realbincounter,self.__histo_3D.GetBinContent(k))
					else :
						newHisto.SetBinError(realbincounter,self.__histo_3D.GetBinError(k))
				realbincounter+=1
		#correct any zero bins not in data
		zeroed_bins = []
		#if self.__name.find('data_obs')==-1 :
		#	#fill zero or less bins with a very small value
		#	fillervalue = 0.00010
		#	if self.__type.endswith('Up') : 
		#		fillervalue = 0.0001005
		#	elif self.__type.endswith('Down') :
		#		fillervalue=0.0000995
		#	realbincounter = 1
		#	for k in range(nglobalbins) :
		#		if not self.__histo_3D.IsBinOverflow(k) and not self.__histo_3D.IsBinUnderflow(k) :
		#			if (bins_to_zero!=None and realbincounter in bins_to_zero) and not self.__modifier.getName()=='top_pt_re_weight' :
		#				newHisto.SetBinContent(realbincounter,fillervalue)
		#				zeroed_bins.append(realbincounter)
		#			elif not self.__histo_3D.GetBinContent(k) > 0. :
		#				newbincont = fillervalue
		#				if nom_1D_histo!=None :
		#					newbincont = nom_1D_histo.GetBinContent(realbincounter)
		#					if self.__type.endswith('Up') : 
		#						newbincont*=(1.005)
		#					elif self.__type.endswith('Down') :
		#						newbincont*=(0.995)
		#				newHisto.SetBinContent(realbincounter,newbincont)
		#				zeroed_bins.append(realbincounter)
		#			realbincounter+=1
		return newHisto,zeroed_bins

	#make_from_1D_histo takes a 1D distribution and makes a template out of it!
	def make_from_1D_histo(self,histo_1D) :
		nglobalbins = self.__histo_3D.GetSize()
		global1Dbincounter = 1
		for k in range(nglobalbins) :
			if not self.__histo_3D.IsBinOverflow(k) and not self.__histo_3D.IsBinUnderflow(k) :
				content = histo_1D.GetBinContent(global1Dbincounter)
				error   = histo_1D.GetBinError(global1Dbincounter)
				self.__histo_3D.SetBinContent(k,content)
				self.__histo_3D.SetBinError(k,error)
				binx = array('i',[0]); biny = array('i',[0]); binz = array('i',[0])
				self.__histo_3D.GetBinXYZ(k,binx,biny,binz)
				self.__histo_x.SetBinContent(binx[0],self.__histo_x.GetBinContent(binx[0])+content)
				self.__histo_y.SetBinContent(biny[0],self.__histo_y.GetBinContent(biny[0])+content)
				self.__histo_z.SetBinContent(binz[0],self.__histo_z.GetBinContent(binz[0])+content)
				self.__histo_x.SetBinError(binx[0],self.__histo_x.GetBinError(binx[0])+error*error)
				self.__histo_y.SetBinError(biny[0],self.__histo_y.GetBinError(biny[0])+error*error)
				self.__histo_z.SetBinError(binz[0],self.__histo_z.GetBinError(binz[0])+error*error)
				global1Dbincounter+=1
		hs = [self.__histo_x,self.__histo_y,self.__histo_z]
		for h in hs :
			for k in range(h.GetSize()) :
				if not h.IsBinUnderflow(k) and not h.IsBinOverflow(k) :
					h.SetBinError(k,sqrt(h.GetBinError(k)))

	#Getters/Setters/Adders
	def getName(self) :
		return self.__name
	def getModifier(self) :
		return self.__modifier
	def getWeightsumDict(self) :
		return self.__weightsum_dict
	def setWeightsumDict(self,newdict) :
		self.__weightsum_dict = newdict
	def getType(self) :
		return self.__type
	def setConversionFactor(self,fac) :
		self.__conversion_factor = fac
	def getHisto3D(self) :
		return self.__histo_3D
	def getHistoX(self) :
		return self.__histo_x
	def getHistoY(self) :
		return self.__histo_y
	def getHistoZ(self) :
		return self.__histo_z
	def getHistos(self) :
		return [self.__histo_3D,self.__histo_x,self.__histo_y,self.__histo_z]
	def setHistos(self,hlist) :
		self.__histo_3D = hlist[0]
		self.__histo_x  = hlist[1]
		self.__histo_y  = hlist[2]
		self.__histo_z  = hlist[3]
	#Private methods
	#get the weight for this event based on reweights
	def __get_event_weight__(self,branch_dict,const_rw_name_list,ss_rw_list,skipiso=False,print_ind_weights=False) :
		eweight = 1.0
		mod = self.__modifier
		#constant reweights
		#s = '' #DEBUG
		if const_rw_name_list!=None :
			for constrw in const_rw_name_list :
				eweight*=branch_dict[constrw].getPTreeValue()
		#		s+= 'after const rw'+constrw+' = '+str(eweight)+', ' #DEBUG
		#simple systematics
		if ss_rw_list!=None :
			ss_weights = [1.0,1.0] #BtoF first, then GH
			for ss in ss_rw_list :
			#if isinstance(ss,str) : #DEBUG
			#	print 'ss = %s'%(ss) #DEBUG
				ssname = ss.getName()
				if ssname.find('_iso_weight')!=-1 and skipiso :
					continue
				thisValueBtoF = 1.0; thisValueGH = 1.0
				if mod!=None and mod.isSSModifier() and mod.getName()==ssname :
					if self.__name.endswith('Up') :
						if ss.isSplit() :
							thisValueBtoF=branch_dict[ssname+'_BtoF_up'].getPTreeValue()
							thisValueGH=branch_dict[ssname+'_GH_up'].getPTreeValue()
						else :
							thisValueBtoF = thisValueGH = branch_dict[ssname+'_up'].getPTreeValue()
					elif self.__name.endswith('Down') :
						if ss.isSplit() :
							thisValueBtoF=branch_dict[ssname+'_BtoF_down'].getPTreeValue()
							thisValueGH=branch_dict[ssname+'_GH_down'].getPTreeValue()
						else :
							thisValueBtoF = thisValueGH = branch_dict[ssname+'_down'].getPTreeValue()
				else :
					if ss.isSplit() :
						thisValueBtoF = branch_dict[ssname+'_BtoF'].getPTreeValue()
						thisValueGH   = branch_dict[ssname+'_GH'].getPTreeValue()
					else :
						thisValueBtoF = thisValueGH = branch_dict[ssname].getPTreeValue()
				ss_weights[0]*=thisValueBtoF; ss_weights[1]*=thisValueGH
		#		s+='after sys. %s rw: %s '%(ssname,ss_weights) #DEBUG
			eweight*=ss_weights[0]+ss_weights[1]
		#	s+='after systematics rw = '+str(eweight)+', ' #DEBUG
		#half the weight if we're adding it twice
		if branch_dict['addTwice'].getPTreeValue() == 1 :
			eweight*=0.5
		#s+='final = '+str(eweight) #DEBUG
		#if print_ind_weights : #DEBUG
		#	print s #DEBUG
		return eweight
	#return a new function string with the total event numbers and fit parameters replaced as necessary
	def __replace_function_string__(self,ttree_identifier,function,fit_par_list) :
		#print 'OLD FUNCTION FOR TTREE IDENTIFIER '+ttree_identifier+' AND TEMPLATE '+self.__name+' = '+function.replace(' ','')
		newfunction1 = ''
		fssen = function.split('@')
		ngg = self.__weightsum_dict['NGG'][ttree_identifier]
		nqq = self.__weightsum_dict['NQQBAR'][ttree_identifier]
		nbck = self.__weightsum_dict['NBCK'][ttree_identifier]
		nwjets = self.__weightsum_dict['NWJETS'][ttree_identifier]
		nqcd = self.__weightsum_dict['NQCD'][ttree_identifier]
		others_list = ['NG1','NG2','NG3','NG4','NQ1','NQ2']
		for s in fssen :
			if s == 'NTOT' :
				newfunction1+='('+str(ngg+nqq+nbck+nwjets+nqcd)+')'
			elif s == 'NBCK' :
				newfunction1+='('+str(nbck)+')'
			elif s == 'NWJETS' :
				newfunction1+='('+str(nwjets)+')'
			elif s == 'NTTBAR' :
				newfunction1+='('+str(ngg+nqq)+')'
			elif s == 'NQQBAR' :
				newfunction1+='('+str(nqq)+')'
			elif s == 'NGG' :
				newfunction1+='('+str(ngg)+')'
			elif s == 'NQCD' :
				newfunction1+='('+str(nqcd)+')'
			elif s in others_list :
				newfunction1+='('+str(self.__weightsum_dict[s][ttree_identifier])+')'
			else :
				newfunction1+=s
		newfunction2 = ''
		fssfp = newfunction1.split('#')
		for s in fssfp :
			replaced = False
			for fitpar in fit_par_list :
				if fitpar.getName() == s :
					if self.__type == 'par_'+fitpar.getName()+'Up' :
						newfunction2+='('+str(fitpar.getUpValue())+')'
					elif self.__type == 'par_'+fitpar.getName()+'Down' :
						newfunction2+='('+str(fitpar.getDownValue())+')'
					else :
						newfunction2+='('+str(fitpar.getNomValue())+')'
					replaced = True
					break
			if not replaced :
				newfunction2+=s
		#print 'NEW FUNCTION FOR TTREE IDENTIFIER '+ttree_identifier+' AND TEMPLATE '+self.__name+' = '+newfunction2.replace(' ','') #DEBUG
		return newfunction2
	#return the weight and opposite weight after applying the function reweights
	def __get_function_weight__(self,branch_dict,functionstring) :
		#replace the individual weights in the function string
		newfunction = ''
		newfunction_opp = ''
		fsser = functionstring.split('$')
		for s in fsser :
			if s in branch_dict.keys() :
				newfunction+='('+str(branch_dict[s].getPTreeValue())+')'
				newfunction_opp+='('+str(branch_dict[s+'_opp'].getPTreeValue())+')'
			else :
				newfunction+=s
				newfunction_opp+=s
		#print '	NEW FUNCTION TO EVALUATE = %s'%(newfunction.replace(' ','')) #DEBUG
		#print '	NEW FUNCTION WITH WEIGHTS = '+str(eval(newfunction))+' = '+newfunction.replace(' ','') #DEBUG
		return eval(newfunction), eval(newfunction_opp)

	def __del__(self) :
		pass

	def __str__(self) :
		s = self.__name
		return s